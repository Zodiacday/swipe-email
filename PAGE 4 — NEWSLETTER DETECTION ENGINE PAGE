4. NEWSLETTER DETECTION ENGINE
The Newsletter Detection Engine identifies which emails are:

Newsletters

Promotions

Marketing blasts

Automated notifications

Social updates

Transactional emails

Unknown / ambiguous

This engine is critical because it powers:

Swipe suggestions

Unsubscribe logic

Automation rules

AI insights

Inbox health scoring

Domain nuke decisions

This page defines the full detection system, including deterministic rules, heuristics, metadata parsing, and edge‑case handling.

4.1 Detection Philosophy
The engine must be:

1. Deterministic first
Use explicit signals before heuristics.

2. Metadata‑only
Never read email content.

3. Provider‑aware
Use Gmail/Outlook categories when available.

4. Safety‑biased
If unsure → classify as unknown, not newsletter.

5. Fast
Detection must run in < 5ms per email.

4.2 Detection Pipeline Overview
The detection pipeline runs in this order:

Provider category detection

Header analysis

List‑Unsubscribe detection

Sender reputation lookup

Frequency analysis

HTML metadata parsing

Heuristic scoring

Final classification

Each step adds confidence to the classification.

4.3 Deterministic Rules (Highest Priority)
These rules override everything else.

Rule 1 — Presence of List‑Unsubscribe Header
If email contains:

Code
List-Unsubscribe: <http://...> or <mailto:...>
→ Classify as newsletter  
Confidence: 1.0

Rule 2 — Gmail Category: Promotions
If Gmail labels include:

CATEGORY_PROMOTIONS

CATEGORY_SOCIAL

→ Classify as newsletter/promo  
Confidence: 0.95

Rule 3 — Outlook “MessageCategory”
If Outlook categorizes as:

“Marketing”

“Newsletter”

→ Classify as newsletter  
Confidence: 0.95

Rule 4 — Sender Domain Patterns
If sender domain matches:

mailchimp.com

sendgrid.net

mailgun.org

constantcontact.com

substack.com

campaignmonitor.com

convertkit.com

klaviyo.com

→ Classify as newsletter  
Confidence: 0.9

4.4 Header Detection
We extract and analyze:

List-Unsubscribe

Precedence

Return-Path

X-Mailer

X-Campaign

X-Newsletter

X-List

X-SG-EID (SendGrid)

X-Mailgun-Sid

X-Mailchimp

Header Rules
If Precedence: bulk → newsletter

If X-Mailer contains “campaign” → newsletter

If X-List exists → newsletter

If Return-Path contains marketing domain → newsletter

Confidence: 0.7–0.9 depending on signal strength.

4.5 HTML Parsing (Metadata Only)
We do not read content.
We only inspect HTML metadata:

Signals
<meta name="newsletter"...>

<meta property="og:newsletter"...>

<meta name="campaign"...>

<meta name="mailing-list"...>

<link rel="unsubscribe"...>

HTML Structure Patterns
Large table‑based layout

Tracking pixels

UTM parameters

“View in browser” links

Confidence: 0.6–0.85

4.6 Frequency Detection
We track:

Emails per day from sender

Emails per week

Time‑of‑day patterns

Batch sending patterns

Volume spikes

Rules
3 emails/week → likely newsletter

1 email/day → high probability

Same timestamp daily → automated

Same subject pattern → automated

Confidence: 0.5–0.8

4.7 Gmail Category Usage
Gmail categories are extremely reliable.

Mapping
CATEGORY_PROMOTIONS → newsletter

CATEGORY_SOCIAL → social update

CATEGORY_UPDATES → transactional

CATEGORY_FORUMS → community

We use these as strong signals but not absolute.

Confidence: 0.8–0.95

4.8 Heuristic Scoring System
We combine all signals into a weighted score:

Signal	Weight
List‑Unsubscribe	0.35
Sender domain reputation	0.25
Gmail/Outlook category	0.20
Frequency	0.10
HTML metadata	0.05
Header patterns	0.05
Classification Thresholds
Score ≥ 0.75 → newsletter

Score 0.50–0.74 → promo/marketing

Score 0.30–0.49 → social/automated

Score < 0.30 → unknown

4.9 Edge Cases & Special Handling
Case 1 — Transactional Emails
Examples:

Receipts

Password resets

Order confirmations

Security alerts

Rules:

Never classify as newsletter

Always classify as transactional

Always KEEP by default

Case 2 — Personal Emails
Rules:

No List‑Unsubscribe

No marketing headers

No bulk patterns

No tracking pixels

Always classify as personal.

Case 3 — Social Notifications
Examples:

LinkedIn

Facebook

Instagram

Twitter/X

Rules:

Category: social

Frequency: high

HTML: notification templates

Classify as social update.

Case 4 — “Grey Zone” Senders
Examples:

Amazon

Apple

Banks

Airlines

Rules:

Use frequency + headers

Never auto‑unsubscribe

Always require user confirmation

Case 5 — Multi‑purpose Senders
Example:

“noreply@company.com” sending both receipts and promos

Rules:

Use subject patterns

Use category

Use metadata

Never assume

4.10 Safety Rules
1. Never unsubscribe from transactional senders
(e.g., Amazon receipts)

2. Never block personal senders
(e.g., real humans)

3. Never nuke domains with mixed content
(e.g., Apple, Google)

4. Always allow undo
Every detection‑based action must be reversible.

5. Never use email content
Metadata only.

4.11 Performance Requirements
Detect 100 emails in < 5ms

Cache sender reputation

Cache domain patterns

Batch header parsing

Avoid full HTML parsing unless necessary

4.12 Output Object
Code
DetectionResult {
  type: "newsletter" | "promo" | "social" | "transactional" | "personal" | "unknown",
  confidence: number,
  signals: {
    list_unsubscribe: boolean,
    sender_reputation: number,
    provider_category: string | null,
    frequency_score: number,
    html_signals: number,
    header_signals: number
  }
}
